<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Task Prioritizer - AI-powered task analysis and prioritization">
  <title>Task Prioritizer</title>
  
  <style>
    /* Global Styles */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      line-height: 1.6;
      color: #333;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 2rem;
    }

    /* Main Container */
    main {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
    }

    h1 {
      font-size: 2.5rem;
      color: #667eea;
      margin-bottom: 1rem;
      text-align: center;
    }

    /* Form Styles */
    #task-form {
      margin-bottom: 2rem;
    }

    label {
      display: block;
      font-weight: 600;
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
      color: #555;
    }

    /* Textarea Styles - T015, T016, T017 */
    #task-input {
      width: 100%;
      padding: 1rem;
      font-size: 1rem;
      font-family: inherit;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      resize: vertical;
      transition: border-color 0.3s ease;
      min-height: 150px;
      white-space: pre-wrap; /* T017: Preserve user input formatting */
    }

    #task-input:focus {
      outline: none;
      border-color: #667eea;
    }

    #task-input::placeholder {
      color: #999;
    }

    /* Responsive textarea sizing - T016 */
    @media (max-width: 768px) {
      #task-input {
        font-size: 16px; /* Prevents zoom on mobile */
        padding: 0.75rem;
      }
    }

    /* Button Styles - T020 */
    button[type="submit"] {
      width: 100%;
      padding: 1rem 2rem;
      font-size: 1.1rem;
      font-weight: 600;
      color: white;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      margin-top: 1rem;
    }

    button[type="submit"]:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    button[type="submit"]:active {
      transform: translateY(0);
    }

    button[type="submit"]:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    /* Error Message Styles - T021 */
    .error {
      color: #e53e3e;
      background-color: #fff5f5;
      border: 1px solid #fc8181;
      border-radius: 6px;
      padding: 0.75rem;
      margin-top: 1rem;
      font-size: 0.95rem;
    }

    .hidden {
      display: none;
    }

    /* Results Container - T030: CSS Grid Layout */
    #results-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      margin-top: 2rem;
      animation: fadeIn 0.4s ease-in;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* T032: Responsive - Stack on mobile */
    @media (max-width: 768px) {
      #results-container {
        grid-template-columns: 1fr;
      }
      
      main {
        padding: 1.5rem;
      }
      
      h1 {
        font-size: 2rem;
      }
    }

    /* Panel Styles - T031 */
    .panel {
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .panel h2 {
      font-size: 1.4rem;
      color: #667eea;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid #667eea;
    }

    /* Original Task Display - T039: Preserve whitespace */
    .task-content {
      background: white;
      padding: 1rem;
      border-radius: 6px;
      border: 1px solid #e0e0e0;
      white-space: pre-wrap;
      word-wrap: break-word;
      font-size: 1rem;
      line-height: 1.6;
      color: #333;
    }

    /* Analysis Display Styles - T038 */
    .analysis-field {
      margin-bottom: 1.5rem;
    }

    .analysis-field:last-child {
      margin-bottom: 0;
    }

    .field-label {
      font-weight: 600;
      font-size: 0.95rem;
      color: #666;
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .field-value {
      font-size: 1rem;
      color: #333;
    }

    /* Priority Badges */
    .priority-badge {
      display: inline-block;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-weight: 600;
      font-size: 1rem;
    }

    .priority-HIGH {
      background-color: #fee;
      color: #c53030;
      border: 2px solid #fc8181;
    }

    .priority-MEDIUM {
      background-color: #fef5e7;
      color: #d97706;
      border: 2px solid #fbbf24;
    }

    .priority-LOW {
      background-color: #f0fdf4;
      color: #059669;
      border: 2px solid #6ee7b7;
    }

    /* Complexity Indicators */
    .complexity-badge {
      display: inline-block;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-weight: 600;
      font-size: 1rem;
    }

    .complexity-HIGH {
      background-color: #fce4ec;
      color: #ad1457;
    }

    .complexity-MEDIUM {
      background-color: #fff3e0;
      color: #e65100;
    }

    .complexity-LOW {
      background-color: #e8f5e9;
      color: #2e7d32;
    }

    /* Category Tags */
    .categories-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .category-tag {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 0.4rem 0.8rem;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 500;
    }

    /* Suggested Order */
    .suggested-order {
      background: white;
      padding: 1rem;
      border-left: 4px solid #667eea;
      border-radius: 4px;
      font-style: italic;
      color: #555;
      line-height: 1.6;
    }
    
    /* T019 [US2]: Warning Banner Styles */
    .warning-banner {
      background-color: #fff3cd;
      color: #856404;
      border: 1px solid #ffc107;
      border-left: 4px solid #ffc107;
      border-radius: 6px;
      padding: 0.75rem 1rem;
      margin-top: 1rem;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      animation: slideIn 0.3s ease-out;
    }
    
    .warning-banner-content {
      flex: 1;
    }
    
    .warning-banner-close {
      background: none;
      border: none;
      color: #856404;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0;
      margin-left: 1rem;
      line-height: 1;
      opacity: 0.7;
      transition: opacity 0.2s ease;
    }
    
    .warning-banner-close:hover {
      opacity: 1;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>
<body>
  <!-- T010: Main container with semantic HTML -->
  <main>
    <!-- T011: Page heading -->
    <h1>Task Prioritizer</h1>
    
    <!-- T012: Form container -->
    <form id="task-form" aria-label="Task analysis form">
      <!-- T013: Label for textarea -->
      <label for="task-input">Enter Task Description</label>
      
      <!-- T014: Textarea input with maxlength and rows -->
      <!-- T048: Enhanced accessibility attributes -->
      <textarea 
        id="task-input" 
        name="task-input"
        maxlength="10000" 
        rows="8"
        placeholder="e.g., Fix the bug in the login form"
        aria-label="Task description input"
        aria-describedby="error-message"
        aria-required="true"
      ></textarea>
      
      <!-- T018: Submit button -->
      <button type="submit" aria-label="Analyze task and show results">Analyze Task</button>
      
      <!-- T019: Error message container -->
      <div id="error-message" class="error hidden" role="alert" aria-live="polite" aria-atomic="true"></div>
    </form>
    
    <!-- T027: Results container (hidden initially) -->
    <div id="results-container" class="hidden">
      <!-- T028: Left panel - Original Task -->
      <div class="panel">
        <h2>Original Task</h2>
        <div id="original-task" class="task-content"></div>
      </div>
      
      <!-- T029: Right panel - AI Analysis -->
      <div class="panel">
        <h2>AI Analysis</h2>
        <div id="analysis-result"></div>
      </div>
    </div>
  </main>
  
  <script type="module">
    // ==============================================
    // TASK PRIORITIZER - WORKSHOP DEMO
    // ==============================================
    // This application demonstrates:
    // - Vanilla JavaScript (no frameworks)
    // - CSS Grid for responsive layout
    // - Form validation
    // - Gemini AI integration for task analysis
    // ==============================================

    // T004: Import Gemini AI SDK
    import { GoogleGenerativeAI } from '@google/generative-ai';
    
    // T008 [US1]: Import Supabase client
    import { createClient } from '@supabase/supabase-js';

    // T054: Workshop comments for clarity

    // Mock Data - Based on contracts/mock-data.json
    // This object simulates AI analysis responses
    // In a real app, this would be an API call
    const mockAnalyses = {
      "Fix the bug in the login form": {
        priority: "HIGH",
        categories: ["CRITICAL-PATH", "USER-FACING", "SECURITY"],
        complexity: "MEDIUM",
        suggestedOrder: "Do this before feature work - blocks user access"
      },
      "Write unit tests for payment module": {
        priority: "HIGH",
        categories: ["TESTING", "CRITICAL-PATH"],
        complexity: "HIGH",
        suggestedOrder: "Essential before next release - prevents regressions in critical path"
      },
      "Update README documentation": {
        priority: "LOW",
        categories: ["DOCUMENTATION"],
        complexity: "LOW",
        suggestedOrder: "Schedule during quiet periods or between sprints"
      },
      "Refactor legacy API endpoints": {
        priority: "MEDIUM",
        categories: ["TECHNICAL-DEBT", "INFRASTRUCTURE"],
        complexity: "HIGH",
        suggestedOrder: "Plan for dedicated refactoring sprint - high effort but not blocking"
      },
      "Add dark mode toggle": {
        priority: "MEDIUM",
        categories: ["FEATURE", "USER-FACING"],
        complexity: "MEDIUM",
        suggestedOrder: "Nice-to-have enhancement - schedule after critical bugs are resolved"
      },
      "Investigate performance bottleneck in search": {
        priority: "HIGH",
        categories: ["BUG-FIX", "USER-FACING"],
        complexity: "MEDIUM",
        suggestedOrder: "Impacts user experience significantly - prioritize investigation and fix"
      }
    };

    // Default analysis for unmatched tasks
    const defaultAnalysis = {
      priority: "MEDIUM",
      categories: ["GENERAL"],
      complexity: "MEDIUM",
      suggestedOrder: "Review and prioritize based on current sprint goals"
    };

    // ==============================================
    // GEMINI AI UTILITY FUNCTIONS
    // ==============================================

    // T005: Construct structured prompt for Gemini API
    function constructPrompt(taskDescription) {
      return `You are a technical task prioritization assistant. Analyze the following work task and determine its priority, categories, complexity, and suggested order.

Return ONLY a valid JSON object with these exact fields (no additional text):

{
  "priority": "HIGH" | "MEDIUM" | "LOW",
  "categories": ["CATEGORY1", "CATEGORY2", ...],
  "complexity": "HIGH" | "MEDIUM" | "LOW",
  "suggestion": "One sentence explaining why this priority makes sense"
}

Priority levels:
- HIGH: Blocks other work, security issues, critical bugs, user-facing failures
- MEDIUM: Important but not blocking, feature work, refactoring with clear value
- LOW: Nice-to-have, documentation, minor improvements

Common categories:
CRITICAL-PATH, USER-FACING, SECURITY, BUG-FIX, FEATURE, TECHNICAL-DEBT, DOCUMENTATION, TESTING, INFRASTRUCTURE, PERFORMANCE, ACCESSIBILITY

Complexity levels:
- HIGH: Multi-day effort, requires extensive testing, touches many systems
- MEDIUM: 1-2 day effort, moderate scope, some dependencies
- LOW: Hours of work, isolated change, minimal risk

Task to analyze:
${taskDescription}

Return ONLY the JSON object:`;
    }

    // T006: Validate Gemini API response structure
    function validateGeminiResponse(response) {
      // Check response is an object
      if (!response || typeof response !== 'object') {
        return { valid: false, error: 'Invalid response format' };
      }
      
      // Validate priority field
      const validPriorities = ['HIGH', 'MEDIUM', 'LOW'];
      if (!validPriorities.includes(response.priority)) {
        return { valid: false, error: 'Invalid priority value' };
      }
      
      // Validate categories field
      if (!Array.isArray(response.categories) || response.categories.length === 0) {
        return { valid: false, error: 'Invalid categories format' };
      }
      
      // Validate complexity field
      const validComplexities = ['HIGH', 'MEDIUM', 'LOW'];
      if (!validComplexities.includes(response.complexity)) {
        return { valid: false, error: 'Invalid complexity value' };
      }
      
      // Validate suggestion field
      if (typeof response.suggestion !== 'string' || response.suggestion.trim().length === 0) {
        return { valid: false, error: 'Missing suggestion text' };
      }
      
      return { valid: true };
    }

    // T007: Classify API errors and map to user-friendly messages
    const ERROR_MESSAGES = {
      API_KEY_MISSING: "Gemini API key not configured. Please add VITE_GEMINI_API_KEY to your .env file.",
      NETWORK_ERROR: "Unable to connect to Gemini AI. Please check your internet connection and try again.",
      AUTH_ERROR: "API authentication failed. Please check your Gemini API key.",
      RATE_LIMIT: "AI service rate limit reached. Please wait a moment before trying again.",
      PARSE_ERROR: "Received invalid response from AI. Please try again.",
      VALIDATION_ERROR: "AI response incomplete. Please try again.",
      UNKNOWN_ERROR: "AI service temporarily unavailable. Please try again shortly."
    };

    function classifyError(error) {
      // Check for missing API key
      if (!import.meta.env.VITE_GEMINI_API_KEY) {
        return { type: 'API_KEY_MISSING', message: ERROR_MESSAGES.API_KEY_MISSING };
      }
      
      // Check for authentication errors
      if (error.status === 401 || error.status === 403) {
        return { type: 'AUTH_ERROR', message: ERROR_MESSAGES.AUTH_ERROR };
      }
      
      // Check for rate limit errors
      if (error.status === 429) {
        return { type: 'RATE_LIMIT', message: ERROR_MESSAGES.RATE_LIMIT };
      }
      
      // Check for network errors
      if (error.message && (error.message.includes('fetch') || error.message.includes('network'))) {
        return { type: 'NETWORK_ERROR', message: ERROR_MESSAGES.NETWORK_ERROR };
      }
      
      // Check for parse errors
      if (error instanceof SyntaxError) {
        return { type: 'PARSE_ERROR', message: ERROR_MESSAGES.PARSE_ERROR };
      }
      
      // Check for validation errors
      if (error.message && error.message.includes('validation')) {
        return { type: 'VALIDATION_ERROR', message: ERROR_MESSAGES.VALIDATION_ERROR };
      }
      
      // Default to unknown error
      return { type: 'UNKNOWN_ERROR', message: ERROR_MESSAGES.UNKNOWN_ERROR };
    }

    // ==============================================
    // VALIDATION & DOM ELEMENTS
    // ==============================================

    // T022: Validation function per data-model.md
    function validateTaskInput(text) {
      const trimmed = text.trim();
      
      if (trimmed.length === 0) {
        return {
          valid: false,
          error: "Please enter a task description"
        };
      }
      
      if (trimmed.length > 10000) {
        return {
          valid: false,
          error: "Task description too long (max 10,000 characters)"
        };
      }
      
      return { valid: true };
    }

    // Get DOM elements
    const form = document.getElementById('task-form');
    const textarea = document.getElementById('task-input');
    const errorMessage = document.getElementById('error-message');
    const resultsContainer = document.getElementById('results-container');
    const originalTaskDiv = document.getElementById('original-task');
    const analysisResultDiv = document.getElementById('analysis-result');
    
    // T043: Debounce flag for rapid submissions
    let isSubmitting = false;

    // ==============================================
    // GEMINI API INITIALIZATION
    // ==============================================

    // T009: Load API key from environment
    const apiKey = import.meta.env.VITE_GEMINI_API_KEY;

    // DEBUG: Log API key status (first 10 chars only for security)
    console.log('üîë API Key loaded:', apiKey ? `${apiKey.substring(0, 10)}...` : 'NOT FOUND');
    console.log('üì¶ All env vars:', import.meta.env);

    // T011 & T012: Initialize Gemini AI client and model
    let genAI = null;
    let model = null;

    if (apiKey) {
      console.log('‚úÖ Initializing Gemini AI client...');
      genAI = new GoogleGenerativeAI(apiKey);
      // Use gemini-2.0-flash-exp for Gemini 2.5 API keys
      model = genAI.getGenerativeModel({ model: 'gemini-2.0-flash-exp' });
      console.log('‚úÖ Gemini AI client initialized successfully with gemini-2.0-flash-exp');
    } else {
      console.error('‚ùå No API key found in environment variables');
    }

    // ==============================================
    // SUPABASE DATABASE LOGGING FUNCTIONS
    // ==============================================
    
    // T009 [US1]: Supabase client singleton
    // This function creates a Supabase client instance only once and reuses it
    // for subsequent database operations. Returns null if credentials are missing.
    let supabaseClient = null;
    
    function getSupabaseClient() {
      // Return existing client if already initialized
      if (supabaseClient) {
        return supabaseClient;
      }
      
      // Load credentials from environment variables
      const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
      const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY;
      
      // Check if both credentials are configured
      if (!supabaseUrl || !supabaseAnonKey) {
        console.warn('‚ö†Ô∏è Supabase credentials not configured - database logging disabled');
        console.warn('üí° To enable logging: Add VITE_SUPABASE_URL and VITE_SUPABASE_ANON_KEY to .env');
        return null;
      }
      
      // Create and cache the client
      supabaseClient = createClient(supabaseUrl, supabaseAnonKey);
      console.log('‚úÖ Supabase client initialized successfully');
      return supabaseClient;
    }
    
    // T010 [US1]: Validate task submission data before database insert
    // This ensures data integrity and catches malformed AI responses early
    function validateTaskSubmission(taskText, analysis) {
      const errors = [];
      
      // Validate task text
      if (!taskText || typeof taskText !== 'string') {
        errors.push('Task text must be a non-empty string');
      } else if (taskText.trim().length === 0) {
        errors.push('Task text cannot be blank');
      }
      
      // Validate priority
      const validPriorities = ['HIGH', 'MEDIUM', 'LOW'];
      if (!validPriorities.includes(analysis.priority)) {
        errors.push(`Invalid priority: ${analysis.priority} (must be HIGH, MEDIUM, or LOW)`);
      }
      
      // Validate categories (must be array, can be empty)
      if (!Array.isArray(analysis.categories)) {
        errors.push('Categories must be an array');
      }
      
      // Validate complexity
      const validComplexities = ['HIGH', 'MEDIUM', 'LOW'];
      if (!validComplexities.includes(analysis.complexity)) {
        errors.push(`Invalid complexity: ${analysis.complexity} (must be HIGH, MEDIUM, or LOW)`);
      }
      
      // Validate suggested order
      if (!analysis.suggestedOrder || typeof analysis.suggestedOrder !== 'string') {
        errors.push('Suggested order must be a non-empty string');
      } else if (analysis.suggestedOrder.trim().length === 0) {
        errors.push('Suggested order cannot be blank');
      }
      
      // Throw error if validation fails
      if (errors.length > 0) {
        throw new Error(`Validation failed: ${errors.join(', ')}`);
      }
      
      return true;
    }
    
    // T016 [US2]: Show warning banner for database errors
    // This creates a dismissible warning banner that auto-hides after 5 seconds
    function showWarning(message) {
      // Create warning banner element
      const warningDiv = document.createElement('div');
      warningDiv.className = 'warning-banner';
      warningDiv.setAttribute('role', 'alert');
      warningDiv.setAttribute('aria-live', 'polite');
      
      // Add message content
      const contentDiv = document.createElement('div');
      contentDiv.className = 'warning-banner-content';
      contentDiv.textContent = message;
      warningDiv.appendChild(contentDiv);
      
      // Add close button
      const closeButton = document.createElement('button');
      closeButton.className = 'warning-banner-close';
      closeButton.textContent = '√ó';
      closeButton.setAttribute('aria-label', 'Close warning');
      closeButton.onclick = () => warningDiv.remove();
      warningDiv.appendChild(closeButton);
      
      // Insert after results container
      const resultsContainer = document.getElementById('results-container');
      resultsContainer.insertAdjacentElement('afterend', warningDiv);
      
      // T020 [US2]: Auto-dismiss after 5 seconds
      setTimeout(() => {
        if (warningDiv.parentNode) {
          warningDiv.remove();
        }
      }, 5000);
    }
    
    // T011 [US1]: Log task submission to Supabase database
    // T015 [US2]: Enhanced with comprehensive error handling
    // This is an async function that inserts the task and AI analysis into the database.
    // It validates data before insertion and throws errors for the caller to handle.
    async function logTaskSubmission(taskText, analysis) {
      // Get Supabase client (may be null if not configured)
      const supabase = getSupabaseClient();
      
      // Silently skip if Supabase is not configured
      if (!supabase) {
        return;
      }
      
      try {
        // Validate data before attempting insert
        validateTaskSubmission(taskText, analysis);
        
        // Prepare insert payload - map AI analysis fields to database columns
        const payload = {
          task_text: taskText,
          priority: analysis.priority,
          categories: analysis.categories,
          complexity: analysis.complexity,
          suggested_order: analysis.suggestedOrder
          // Note: id and created_at are auto-generated by database
        };
        
        // Insert to Supabase (T013: console logging for debugging)
        const { data, error } = await supabase
          .from('task_submissions')
          .insert([payload]);
        
        // T015 [US2]: Check for database errors and re-throw with descriptive message
        if (error) {
          // Classify the error type for better debugging
          let errorType = 'Database error';
          if (error.code === '23502') {
            errorType = 'Missing required field';
          } else if (error.code === '23514') {
            errorType = 'Invalid field value';
          } else if (error.code === '42501') {
            errorType = 'Permission denied (RLS policy)';
          } else if (error.message.includes('fetch')) {
            errorType = 'Network error';
          }
          
          throw new Error(`${errorType}: ${error.message}`);
        }
        
        // T013 [US1]: Success logging for debugging
        console.log('‚úÖ Task logged to database successfully:', data);
        
      } catch (error) {
        // T018 [US2]: Enhanced console warning for debugging
        console.warn('‚ùå Database logging failed:', error.message);
        console.warn('üí° This does not affect the AI analysis - the app continues working normally');
        throw error; // Re-throw for caller to handle
      }
    }

    // ==============================================
    // TASK ANALYSIS FUNCTIONS
    // ==============================================

    // T015-T020: Analyze task using Gemini AI
    async function analyzeTaskWithGemini(taskDescription) {
      // T016: Construct API request
      const prompt = constructPrompt(taskDescription);
      
      const request = {
        contents: [{
          role: 'user',
          parts: [{ text: prompt }]
        }],
        generationConfig: {
          responseMimeType: 'application/json',
          temperature: 0.3,
          maxOutputTokens: 1024
        }
      };

      // T017: Call Gemini API
      const result = await model.generateContent(request);
      
      // T018: Parse JSON response
      const responseText = result.response.text();
      const analysis = JSON.parse(responseText);
      
      // T019: Validate response
      const validation = validateGeminiResponse(analysis);
      if (!validation.valid) {
        const error = new Error('validation');
        error.details = validation.error;
        throw error;
      }
      
      // T020: Return validated analysis
      return {
        priority: analysis.priority,
        categories: analysis.categories,
        complexity: analysis.complexity,
        suggestedOrder: analysis.suggestion
      };
    }

    // T034: Analyze task using mock data lookup (kept as fallback)
    function analyzeTask(taskDescription) {
      const normalizedText = taskDescription.trim();
      
      // Exact match lookup in mock data
      if (mockAnalyses[normalizedText]) {
        return mockAnalyses[normalizedText];
      }
      
      // Return default analysis for unmatched tasks
      return defaultAnalysis;
    }

    // T036: Display analysis with formatted HTML
    function displayAnalysis(analysis) {
      let html = '';
      
      // Priority
      html += `
        <div class="analysis-field">
          <div class="field-label">Priority</div>
          <div class="field-value">
            <span class="priority-badge priority-${analysis.priority}">${analysis.priority}</span>
          </div>
        </div>
      `;
      
      // Categories
      html += `
        <div class="analysis-field">
          <div class="field-label">Categories</div>
          <div class="categories-list">
            ${analysis.categories.map(cat => `<span class="category-tag">${cat}</span>`).join('')}
          </div>
        </div>
      `;
      
      // Complexity
      html += `
        <div class="analysis-field">
          <div class="field-label">Estimated Complexity</div>
          <div class="field-value">
            <span class="complexity-badge complexity-${analysis.complexity}">${analysis.complexity}</span>
          </div>
        </div>
      `;
      
      // Suggested Order
      html += `
        <div class="analysis-field">
          <div class="field-label">Suggested Order</div>
          <div class="suggested-order">${analysis.suggestedOrder}</div>
        </div>
      `;
      
      return html;
    }

    // T035: Display results - populate original task
    function displayResults(taskText, analysis) {
      // T040: Clear previous results before displaying new ones
      originalTaskDiv.textContent = '';
      analysisResultDiv.innerHTML = '';
      
      // Small delay for smooth transition (T042: fade effect)
      setTimeout(() => {
        // Display original task text (preserves formatting)
        originalTaskDiv.textContent = taskText;
        
        // Display formatted analysis
        analysisResultDiv.innerHTML = displayAnalysis(analysis);
      }, 50);
      
      // T037: Show results container
      resultsContainer.classList.remove('hidden');
      
      // Smooth scroll to results
      resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    // T023: Form submit event handler (T041: supports repeated submissions)
    // T021: Made async to support Gemini API integration
    async function handleSubmit(event) {
      event.preventDefault();
      
      // T043: Prevent rapid duplicate submissions
      if (isSubmitting) {
        return;
      }
      
      const taskText = textarea.value;
      
      // T024: Show error for empty textarea
      const validation = validateTaskInput(taskText);
      if (!validation.valid) {
        errorMessage.textContent = validation.error;
        errorMessage.classList.remove('hidden');
        return;
      }
      
      // T025: Clear error on valid input
      errorMessage.classList.add('hidden');
      errorMessage.textContent = '';
      
      // T039: Show loading state
      isSubmitting = true;
      const submitButton = form.querySelector('button[type="submit"]');
      const originalButtonText = submitButton.textContent;
      submitButton.disabled = true;
      submitButton.textContent = 'Analyzing...';
      
      try {
        // T026-T034: Comprehensive error handling with try-catch
        let analysis;
        
        // Check if API key is configured
        if (!apiKey || !model) {
          const errorInfo = classifyError(new Error('API_KEY_MISSING'));
          throw new Error(errorInfo.message);
        }
        
        // T021: Call Gemini API for analysis
        analysis = await analyzeTaskWithGemini(taskText);
        
        // T022: Display results (existing function works with AI analysis)
        displayResults(taskText, analysis);
        
        // T012 [US1]: Fire-and-forget database logging
        // T017 [US2]: Enhanced with user-facing warning
        // This logs the task submission to Supabase AFTER displaying results
        // The .catch() handles errors without blocking the UI
        logTaskSubmission(taskText, analysis).catch(error => {
          // T017 [US2]: Show subtle warning banner to user
          showWarning('Note: Task history could not be saved at this time');
        });
        
      } catch (error) {
        // DEBUG: Log the actual error
        console.error('‚ùå Error during API call:', error);
        console.error('Error details:', {
          message: error.message,
          status: error.status,
          stack: error.stack
        });
        
        // T027-T033: Error classification and user-friendly messages
        const errorInfo = classifyError(error);
        console.log('üìã Classified error:', errorInfo);
        errorMessage.textContent = errorInfo.message;
        errorMessage.classList.remove('hidden');
        
        // T035: Hide results container on error
        resultsContainer.classList.add('hidden');
      } finally {
        // T041: Reset loading state
        submitButton.disabled = false;
        submitButton.textContent = originalButtonText;
        isSubmitting = false;
      }
      
      // T044: Don't clear textarea (allow easy editing for next submission)
    }

    // T026: Event handlers to clear error message
    textarea.addEventListener('input', () => {
      if (!errorMessage.classList.contains('hidden')) {
        errorMessage.classList.add('hidden');
        errorMessage.textContent = '';
      }
    });

    textarea.addEventListener('focus', () => {
      if (!errorMessage.classList.contains('hidden')) {
        errorMessage.classList.add('hidden');
        errorMessage.textContent = '';
      }
    });

    // Attach form submit handler
    form.addEventListener('submit', handleSubmit);
  </script>
</body>
</html>

